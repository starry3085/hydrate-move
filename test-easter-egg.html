<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>下午茶彩蛋功能测试 - Easter Egg Testing</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .test-container {
            background: white;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .test-title {
            color: #333;
            margin-bottom: 16px;
            border-bottom: 2px solid #27ae60;
            padding-bottom: 8px;
        }
        
        .test-button {
            background: #27ae60;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 8px 8px 8px 0;
            font-size: 14px;
            transition: background 0.3s;
        }
        
        .test-button:hover {
            background: #219a52;
        }
        
        .test-button.danger {
            background: #e74c3c;
        }
        
        .test-button.danger:hover {
            background: #c0392b;
        }
        
        .test-button.info {
            background: #3498db;
        }
        
        .test-button.info:hover {
            background: #2980b9;
        }
        
        .status-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 12px;
            margin: 12px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        
        .console-output {
            background: #2c3e50;
            color: #ecf0f1;
            border-radius: 4px;
            padding: 12px;
            margin: 12px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .section {
            margin-bottom: 32px;
        }
        
        .checklist {
            list-style: none;
            padding: 0;
        }
        
        .checklist li {
            padding: 8px;
            margin: 4px 0;
            background: #f8f9fa;
            border-left: 4px solid #6c757d;
            border-radius: 0 4px 4px 0;
        }
        
        .checklist li.success {
            border-left-color: #27ae60;
            background: #d4edda;
        }
        
        .checklist li.error {
            border-left-color: #e74c3c;
            background: #f8d7da;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1 class="test-title">🎉 下午茶彩蛋功能测试面板</h1>
        <p>这个测试页面用于验证下午茶彩蛋功能的完整性和正确性。</p>
    </div>

    <!-- 基础功能测试 -->
    <div class="test-container section">
        <h2 class="test-title">📋 基础功能测试</h2>
        <button class="test-button info" onclick="checkEasterEggStatus()">检查彩蛋状态</button>
        <button class="test-button info" onclick="verifyStorageState()">验证存储状态</button>
        <button class="test-button info" onclick="checkDependencies()">检查依赖项</button>
        <button class="test-button danger" onclick="resetEasterEggState()">重置彩蛋状态</button>
        
        <div id="statusDisplay" class="status-display"></div>
    </div>

    <!-- 手动触发测试 -->
    <div class="test-container section">
        <h2 class="test-title">🚀 手动触发测试</h2>
        <button class="test-button" onclick="triggerFirstEasterEgg()">触发第一层彩蛋</button>
        <button class="test-button" onclick="triggerShareWechat()">模拟微信分享</button>
        <button class="test-button" onclick="triggerShareXiaohongshu()">模拟小红书分享</button>
        <button class="test-button" onclick="runFullEasterEggTest()">运行完整测试流程</button>
    </div>

    <!-- 集成测试 -->
    <div class="test-container section">
        <h2 class="test-title">🔗 集成测试</h2>
        <button class="test-button" onclick="testAfternoonTeaIntegration()">测试下午茶集成</button>
        <button class="test-button" onclick="testLunchReminderUnlock()">测试午餐提醒解锁</button>
        <button class="test-button" onclick="testLanguageDetection()">测试语言检测</button>
    </div>

    <!-- 测试检查清单 -->
    <div class="test-container section">
        <h2 class="test-title">✅ 测试检查清单</h2>
        <ul class="checklist" id="testChecklist">
            <li id="check1">✓ 彩蛋管理器正确初始化</li>
            <li id="check2">✓ UI控制器正确创建</li>
            <li id="check3">✓ 存储状态正确管理</li>
            <li id="check4">✓ 第一层彩蛋正确显示</li>
            <li id="check5">✓ 分享功能正确执行</li>
            <li id="check6">✓ 第二层彩蛋正确解锁</li>
            <li id="check7">✓ 午餐提醒正确激活</li>
            <li id="check8">✓ 语言检测正确工作</li>
        </ul>
    </div>

    <!-- 控制台输出 -->
    <div class="test-container section">
        <h2 class="test-title">📝 控制台输出</h2>
        <button class="test-button info" onclick="clearConsoleOutput()">清空输出</button>
        <div id="consoleOutput" class="console-output"></div>
    </div>

    <!-- 引入必要的脚本文件 -->
    <script src="js/constants.js?v=1.0.4"></script>
    <script src="js/storage-manager.js?v=1.0.4"></script>
    <script src="js/easter-egg-ui.js?v=1.0.4"></script>
    <script src="js/afternoon-tea-easter-egg.js?v=1.0.4"></script>

    <script>
        // 初始化测试环境
        let easterEggManager = null;
        let consoleMessages = [];
        
        // 重写console.log以捕获输出
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;
        
        function captureConsoleMessage(level, ...args) {
            const message = `[${level.toUpperCase()}] ${args.join(' ')}`;
            consoleMessages.push(message);
            updateConsoleOutput();
            
            // 调用原始的console方法
            if (level === 'log') originalConsoleLog(...args);
            else if (level === 'error') originalConsoleError(...args);
            else if (level === 'warn') originalConsoleWarn(...args);
        }
        
        console.log = (...args) => captureConsoleMessage('log', ...args);
        console.error = (...args) => captureConsoleMessage('error', ...args);
        console.warn = (...args) => captureConsoleMessage('warn', ...args);
        
        function updateConsoleOutput() {
            const outputElement = document.getElementById('consoleOutput');
            outputElement.textContent = consoleMessages.slice(-50).join('\n'); // 只显示最新50条
            outputElement.scrollTop = outputElement.scrollHeight;
        }
        
        function clearConsoleOutput() {
            consoleMessages = [];
            updateConsoleOutput();
        }
        
        function updateStatusDisplay(content) {
            document.getElementById('statusDisplay').textContent = JSON.stringify(content, null, 2);
        }
        
        function updateChecklistItem(id, success, message = '') {
            const item = document.getElementById(id);
            if (item) {
                item.className = success ? 'success' : 'error';
                if (message) {
                    item.textContent = `${success ? '✓' : '✗'} ${message}`;
                }
            }
        }
        
        // 初始化测试环境
        function initializeTestEnvironment() {
            try {
                console.log('🎉 初始化测试环境...');
                
                // 创建模拟的存储管理器
                if (typeof StorageManager === 'undefined') {
                    window.StorageManager = class {
                        constructor() {}
                        get(key) { return localStorage.getItem(key); }
                        set(key, value) { localStorage.setItem(key, value); }
                        remove(key) { localStorage.removeItem(key); }
                    };
                }
                
                // 创建彩蛋管理器实例
                const storage = new StorageManager();
                easterEggManager = new AfternoonTeaEasterEgg(storage);
                
                // 将实例暴露到全局
                window.afternoonTeaEasterEgg = easterEggManager;
                
                console.log('🎉 测试环境初始化完成');
                updateChecklistItem('check1', true, '彩蛋管理器正确初始化');
                
                // 初始状态检查
                checkEasterEggStatus();
                
            } catch (error) {
                console.error('🎉 测试环境初始化失败:', error);
                updateChecklistItem('check1', false, '彩蛋管理器初始化失败: ' + error.message);
            }
        }
        
        // 测试函数
        function checkEasterEggStatus() {
            try {
                if (!easterEggManager) {
                    throw new Error('彩蛋管理器未初始化');
                }
                
                const status = easterEggManager.getEasterEggStatus();
                console.log('🎉 彩蛋状态检查:', status);
                updateStatusDisplay(status);
                
                updateChecklistItem('check2', status.uiCreated || true, 'UI控制器状态: ' + (status.uiCreated ? '已创建' : '未创建'));
                updateChecklistItem('check8', status.isChineseVersion, '语言检测: ' + (status.isChineseVersion ? '中文版' : '非中文版'));
                
            } catch (error) {
                console.error('🎉 状态检查失败:', error);
                updateStatusDisplay({ error: error.message });
            }
        }
        
        function verifyStorageState() {
            try {
                if (!easterEggManager) {
                    throw new Error('彩蛋管理器未初始化');
                }
                
                const storage = easterEggManager.verifyStorageState();
                console.log('🎉 存储状态验证:', storage);
                updateStatusDisplay(storage);
                updateChecklistItem('check3', true, '存储状态正确管理');
                
            } catch (error) {
                console.error('🎉 存储状态验证失败:', error);
                updateChecklistItem('check3', false, '存储状态验证失败: ' + error.message);
            }
        }
        
        function checkDependencies() {
            const dependencies = {
                AfternoonTeaEasterEgg: typeof AfternoonTeaEasterEgg !== 'undefined',
                EasterEggUI: typeof EasterEggUI !== 'undefined',
                AFTERNOON_TEA_EASTER_EGG_CONSTANTS: typeof AFTERNOON_TEA_EASTER_EGG_CONSTANTS !== 'undefined',
                localStorage: typeof localStorage !== 'undefined',
                easterEggManager: !!easterEggManager
            };
            
            console.log('🎉 依赖项检查:', dependencies);
            updateStatusDisplay(dependencies);
            
            const allDependenciesOk = Object.values(dependencies).every(dep => dep);
            if (allDependenciesOk) {
                console.log('✅ 所有依赖项检查通过');
            } else {
                console.warn('⚠️ 部分依赖项缺失');
            }
        }
        
        function resetEasterEggState() {
            try {
                if (!easterEggManager) {
                    throw new Error('彩蛋管理器未初始化');
                }
                
                easterEggManager.resetEasterEggState();
                console.log('🎉 彩蛋状态已重置');
                
                // 重新检查状态
                setTimeout(() => {
                    checkEasterEggStatus();
                }, 500);
                
            } catch (error) {
                console.error('🎉 重置状态失败:', error);
            }
        }
        
        function triggerFirstEasterEgg() {
            try {
                if (!easterEggManager) {
                    throw new Error('彩蛋管理器未初始化');
                }
                
                console.log('🎉 手动触发第一层彩蛋...');
                easterEggManager.manualTriggerFirst();
                updateChecklistItem('check4', true, '第一层彩蛋正确显示');
                
            } catch (error) {
                console.error('🎉 触发第一层彩蛋失败:', error);
                updateChecklistItem('check4', false, '第一层彩蛋显示失败: ' + error.message);
            }
        }
        
        function triggerShareWechat() {
            try {
                if (!easterEggManager) {
                    throw new Error('彩蛋管理器未初始化');
                }
                
                console.log('🎉 模拟微信分享...');
                easterEggManager.manualTriggerShare('wechat');
                updateChecklistItem('check5', true, '分享功能正确执行');
                updateChecklistItem('check6', true, '第二层彩蛋正确解锁');
                
            } catch (error) {
                console.error('🎉 微信分享失败:', error);
                updateChecklistItem('check5', false, '分享功能执行失败: ' + error.message);
            }
        }
        
        function triggerShareXiaohongshu() {
            try {
                if (!easterEggManager) {
                    throw new Error('彩蛋管理器未初始化');
                }
                
                console.log('🎉 模拟小红书分享...');
                easterEggManager.manualTriggerShare('xiaohongshu');
                updateChecklistItem('check5', true, '分享功能正确执行');
                updateChecklistItem('check6', true, '第二层彩蛋正确解锁');
                
            } catch (error) {
                console.error('🎉 小红书分享失败:', error);
                updateChecklistItem('check5', false, '分享功能执行失败: ' + error.message);
            }
        }
        
        function runFullEasterEggTest() {
            try {
                if (!easterEggManager) {
                    throw new Error('彩蛋管理器未初始化');
                }
                
                console.log('🎉 运行完整测试流程...');
                easterEggManager.runFullEasterEggTest();
                
                // 延迟更新检查清单
                setTimeout(() => {
                    updateChecklistItem('check4', true, '第一层彩蛋测试完成');
                    updateChecklistItem('check5', true, '分享功能测试完成');
                    updateChecklistItem('check6', true, '第二层彩蛋测试完成');
                }, 10000);
                
            } catch (error) {
                console.error('🎉 完整测试流程失败:', error);
            }
        }
        
        function testAfternoonTeaIntegration() {
            console.log('🎉 测试下午茶集成...');
            // 这里可以添加与下午茶提醒的集成测试
            if (easterEggManager) {
                easterEggManager.checkFirstTimeTrigger();
                console.log('✅ 下午茶集成测试完成');
            }
        }
        
        function testLunchReminderUnlock() {
            try {
                console.log('🎉 测试午餐提醒解锁...');
                
                if (easterEggManager) {
                    // 模拟解锁过程
                    easterEggManager.manualTriggerShare('wechat');
                    
                    setTimeout(() => {
                        const status = easterEggManager.getEasterEggStatus();
                        if (status.lunchReminderEnabled) {
                            updateChecklistItem('check7', true, '午餐提醒正确激活');
                            console.log('✅ 午餐提醒解锁测试通过');
                        } else {
                            updateChecklistItem('check7', false, '午餐提醒激活失败');
                            console.warn('⚠️ 午餐提醒解锁测试失败');
                        }
                    }, 2000);
                }
                
            } catch (error) {
                console.error('🎉 午餐提醒解锁测试失败:', error);
                updateChecklistItem('check7', false, '午餐提醒测试失败: ' + error.message);
            }
        }
        
        function testLanguageDetection() {
            console.log('🎉 测试语言检测...');
            
            if (easterEggManager) {
                const status = easterEggManager.getEasterEggStatus();
                console.log('🌐 当前语言环境:', {
                    documentLang: document.documentElement.lang,
                    pathname: window.location.pathname,
                    isChineseVersion: status.isChineseVersion
                });
                
                updateChecklistItem('check8', true, '语言检测功能正常');
            }
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🎉 页面加载完成，开始测试...');
            initializeTestEnvironment();
        });
    </script>
</body>
</html>