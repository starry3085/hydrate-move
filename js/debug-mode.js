/**
 * Debug Mode Manager
 * URLÂèÇÊï∞Ë∞ÉËØïÊ®°ÂºèÁÆ°ÁêÜÂô®
 * 
 * ÊîØÊåÅÁöÑURLÂèÇÊï∞Ôºö
 * ?debug=1 - ÂêØÁî®Ë∞ÉËØïÊ®°Âºè
 * ?debug=1&reset=true - Ëá™Âä®ÈáçÁΩÆÁä∂ÊÄÅ
 * ?debug=1&trigger=break - Âº∫Âà∂Ëß¶Âèë‰∏ãÂçàËå∂
 * ?debug=1&trigger=lunch - Âº∫Âà∂Ëß¶ÂèëÂçàÈ§ê
 * ?debug=1&break_time=16:05 - ËÆæÁΩÆ‰∏ãÂçàËå∂Êó∂Èó¥
 * ?debug=1&lunch_time=12:30 - ËÆæÁΩÆÂçàÈ§êÊó∂Èó¥
 */

class DebugModeManager {
    constructor() {
        this.isDebugMode = false;
        this.urlParams = new URLSearchParams(window.location.search);
        this.debugConfig = {
            enabled: false,
            autoReset: false,
            triggerType: null,
            breakTime: null,
            lunchTime: null
        };
        
        // Ëß£ÊûêURLÂèÇÊï∞
        this.parseUrlParameters();
        
        // Â¶ÇÊûúÂêØÁî®Ë∞ÉËØïÊ®°ÂºèÔºåÂàùÂßãÂåñË∞ÉËØïÂäüËÉΩ
        if (this.isDebugMode) {
            this.initializeDebugMode();
        }
    }
    
    /**
     * Ëß£ÊûêURLÂèÇÊï∞
     * @private
     */
    parseUrlParameters() {
        // Ê£ÄÊü•ÊòØÂê¶ÂêØÁî®Ë∞ÉËØïÊ®°Âºè
        const debugParam = this.urlParams.get('debug');
        this.isDebugMode = debugParam === '1' || debugParam === 'true';
        
        if (!this.isDebugMode) {
            return;
        }
        
        // Ëß£ÊûêË∞ÉËØïÈÖçÁΩÆ
        this.debugConfig.enabled = true;
        this.debugConfig.autoReset = this.urlParams.get('reset') === 'true';
        this.debugConfig.triggerType = this.urlParams.get('trigger');
        this.debugConfig.breakTime = this.urlParams.get('break_time');
        this.debugConfig.lunchTime = this.urlParams.get('lunch_time');
        
        console.log('üîß Ë∞ÉËØïÊ®°ÂºèURLÂèÇÊï∞Ëß£ÊûêÂÆåÊàê:', this.debugConfig);
    }
    
    /**
     * ÂàùÂßãÂåñË∞ÉËØïÊ®°Âºè
     * @private
     */
    initializeDebugMode() {
        console.log('üîß Ë∞ÉËØïÊ®°ÂºèÂ∑≤ÂêØÁî®');
        
        // ÊòæÁ§∫Ë∞ÉËØïÊ®°ÂºèÊåáÁ§∫Âô®
        this.showDebugIndicator();
        
        // Â¢ûÂº∫Áé∞ÊúâÁöÑtestEasterEggÂØπË±°
        this.enhanceTestEasterEgg();
        
        // Á≠âÂæÖÂ∫îÁî®ÂàùÂßãÂåñÂÆåÊàêÂêéÊâßË°åURLÂèÇÊï∞Êåá‰ª§
        // Use multiple strategies to ensure commands execute after app initialization
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                setTimeout(() => {
                    this.executeUrlCommands();
                }, 2000); // Increased delay to ensure app is fully loaded
            });
        } else {
            setTimeout(() => {
                this.executeUrlCommands();
            }, 2000);
        }
        
        // Also try to execute when the app object becomes available
        const checkAppReady = () => {
            if (window.app || window.testEasterEgg) {
                setTimeout(() => {
                    this.executeUrlCommands();
                }, 500);
            } else {
                setTimeout(checkAppReady, 200);
            }
        };
        checkAppReady();
    }
    
    /**
     * ÊòæÁ§∫Ë∞ÉËØïÊ®°ÂºèÊåáÁ§∫Âô®
     * @private
     */
    showDebugIndicator() {
        // ÂàõÂª∫Ë∞ÉËØïÊ®°ÂºèÊåáÁ§∫Âô®
        const indicator = document.createElement('div');
        indicator.id = 'debug-mode-indicator';
        indicator.innerHTML = 'üîß Ë∞ÉËØïÊ®°Âºè';
        indicator.style.cssText = `
            position: fixed;
            top: 10px;
            right: 10px;
            background: #f39c12;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            z-index: 2147483647;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        `;
        
        // Ê∑ªÂä†Âà∞È°µÈù¢
        document.body.appendChild(indicator);
        
        // 5ÁßíÂêéËá™Âä®ÈöêËóè
        setTimeout(() => {
            if (indicator.parentNode) {
                indicator.parentNode.removeChild(indicator);
            }
        }, 5000);
    }
    
    /**
     * Â¢ûÂº∫testEasterEggÂØπË±°
     * @private
     */
    enhanceTestEasterEgg() {
        // Á≠âÂæÖtestEasterEggÂØπË±°ÂàõÂª∫
        const checkTestEasterEgg = () => {
            if (window.testEasterEgg) {
                this.addDebugMethods();
            } else {
                setTimeout(checkTestEasterEgg, 100);
            }
        };
        checkTestEasterEgg();
    }
    
    /**
     * ‰∏∫testEasterEggÂØπË±°Ê∑ªÂä†Ë∞ÉËØïÊñπÊ≥ï
     * @private
     */
    addDebugMethods() {
        // ‰øùÂ≠òÂéüÊúâÊñπÊ≥ï
        const originalMethods = { ...window.testEasterEgg };
        
        // Êâ©Â±ïË∞ÉËØïÊñπÊ≥ï
        Object.assign(window.testEasterEgg, {
            // Êó∂Èó¥ËÆæÁΩÆÊñπÊ≥ï
            setBreakTime: (time) => {
                this.setTriggerTime('break', time);
            },
            
            setLunchTime: (time) => {
                this.setTriggerTime('lunch', time);
            },
            
            // Âº∫Âà∂Ëß¶ÂèëÊñπÊ≥ïÔºà‰ΩøÁî®ÂèãÂ•ΩÁöÑÂëΩÂêçÔºâ
            triggerBreak: () => {
                this.forceTrigger('break');
            },
            
            triggerLunch: () => {
                this.forceTrigger('lunch');
            },
            
            // Áõ¥Êé•Ëß¶ÂèëÂΩ©ËõãÔºàÁªïËøáÊó∂Èó¥Ê£ÄÊü•Ôºâ
            forceEasterEgg: () => {
                console.log('üîß Forcing easter egg popup display...');
                if (window.afternoonTeaEasterEgg) {
                    // Reset state to allow showing
                    localStorage.removeItem('afternoonTeaFirstEasterEggShown');
                    
                    // Ensure UI is created
                    if (!window.afternoonTeaEasterEgg.ui) {
                        window.afternoonTeaEasterEgg.createUI();
                    }
                    
                    // Try direct UI trigger
                    if (window.afternoonTeaEasterEgg.ui && window.afternoonTeaEasterEgg.ui.showFirstEasterEgg) {
                        window.afternoonTeaEasterEgg.ui.showFirstEasterEgg();
                        console.log('üîß ‚úÖ Easter egg popup forced via UI');
                    } else {
                        // Fallback to checkFirstTimeTrigger
                        window.afternoonTeaEasterEgg.checkFirstTimeTrigger();
                        console.log('üîß ‚úÖ Easter egg forced via checkFirstTimeTrigger');
                    }
                } else {
                    console.warn('üîß afternoonTeaEasterEgg not available');
                }
            },
            
            // ÊâãÂä®ÊòæÁ§∫Á¨¨‰∏ÄÂ±ÇÂΩ©Ëõã
            showEasterEgg: () => {
                if (window.afternoonTeaEasterEgg && window.afternoonTeaEasterEgg.manualTriggerFirst) {
                    window.afternoonTeaEasterEgg.manualTriggerFirst();
                    console.log('üîß Manually triggered first easter egg');
                } else {
                    console.warn('üîß manualTriggerFirst method not available');
                }
            },
            
            // ÊµãËØïÈÄöÁü•ÊùÉÈôê
            testNotification: () => {
                if (window.app && window.app.notificationService) {
                    window.app.notificationService.showNotification(
                        'water',
                        'üîß Debug Test',
                        'This is a debug notification test'
                    );
                    console.log('üîß Test notification sent');
                } else {
                    console.warn('üîß Notification service not available');
                }
            },
            
            // ÂàÜÂà´ÈáçÁΩÆÁä∂ÊÄÅ
            resetBreak: () => {
                this.resetSpecificState('break');
            },
            
            resetLunch: () => {
                this.resetSpecificState('lunch');
            },
            
            // Ëé∑ÂèñË∞ÉËØï‰ø°ÊÅØ
            getDebugInfo: () => {
                return this.getDebugInfo();
            },
            
            // ÊòæÁ§∫Ë∞ÉËØïÂ∏ÆÂä©
            help: () => {
                this.showDebugHelp();
            }
        });
        
        console.log('üîß testEasterEggÂØπË±°Â∑≤Â¢ûÂº∫ÔºåÊñ∞Â¢ûË∞ÉËØïÊñπÊ≥ï:');
        console.log('  - testEasterEgg.setBreakTime("16:05") // ËÆæÁΩÆ‰∏ãÂçàËå∂Êó∂Èó¥');
        console.log('  - testEasterEgg.setLunchTime("12:30") // ËÆæÁΩÆÂçàÈ§êÊó∂Èó¥');
        console.log('  - testEasterEgg.triggerBreak() // Âº∫Âà∂Ëß¶Âèë‰∏ãÂçàËå∂');
        console.log('  - testEasterEgg.triggerLunch() // Âº∫Âà∂Ëß¶ÂèëÂçàÈ§ê');
        console.log('  - testEasterEgg.forceEasterEgg() // Áõ¥Êé•Ëß¶ÂèëÂΩ©ËõãÔºàÁªïËøáÊó∂Èó¥Ê£ÄÊü•Ôºâ');
        console.log('  - testEasterEgg.showEasterEgg() // ÊâãÂä®ÊòæÁ§∫Á¨¨‰∏ÄÂ±ÇÂΩ©Ëõã');
        console.log('  - testEasterEgg.testNotification() // ÊµãËØïÈÄöÁü•ÊùÉÈôê');
        console.log('  - testEasterEgg.resetBreak() // ÈáçÁΩÆ‰∏ãÂçàËå∂Áä∂ÊÄÅ');
        console.log('  - testEasterEgg.resetLunch() // ÈáçÁΩÆÂçàÈ§êÁä∂ÊÄÅ');
        console.log('  - testEasterEgg.getDebugInfo() // Ëé∑ÂèñË∞ÉËØï‰ø°ÊÅØ');
        console.log('  - testEasterEgg.help() // ÊòæÁ§∫Â∏ÆÂä©');
    }
    
    /**
     * ËÆæÁΩÆËß¶ÂèëÊó∂Èó¥
     * @param {string} type - Á±ªÂûã ('break' | 'lunch')
     * @param {string} time - Êó∂Èó¥Ê†ºÂºè 'HH:MM'
     */
    setTriggerTime(type, time) {
        if (!this.validateTimeFormat(time)) {
            console.error(`üîß Êó∂Èó¥Ê†ºÂºèÈîôËØØ: ${time}ÔºåÊ≠£Á°ÆÊ†ºÂºè: HH:MM (Â¶Ç 16:05)`);
            return;
        }
        
        const [hour, minute] = time.split(':').map(num => parseInt(num, 10));
        
        try {
            if (type === 'break') {
                // ‰∏¥Êó∂‰øÆÊîπ‰∏ãÂçàËå∂Êó∂Èó¥
                if (window.AFTERNOON_TEA_CONSTANTS) {
                    window.AFTERNOON_TEA_CONSTANTS.REMINDER_TIME.HOUR = hour;
                    window.AFTERNOON_TEA_CONSTANTS.REMINDER_TIME.MINUTE = minute;
                    console.log(`üîß ‰∏ãÂçàËå∂Êó∂Èó¥Â∑≤ËÆæÁΩÆ‰∏∫: ${time}`);
                }
            } else if (type === 'lunch') {
                // ‰∏¥Êó∂‰øÆÊîπÂçàÈ§êÊó∂Èó¥
                if (window.LUNCH_REMINDER_CONSTANTS) {
                    window.LUNCH_REMINDER_CONSTANTS.REMINDER_TIME.HOUR = hour;
                    window.LUNCH_REMINDER_CONSTANTS.REMINDER_TIME.MINUTE = minute;
                    console.log(`üîß ÂçàÈ§êÊó∂Èó¥Â∑≤ËÆæÁΩÆ‰∏∫: ${time}`);
                }
            }
        } catch (error) {
            console.error(`üîß ËÆæÁΩÆ${type}Êó∂Èó¥Â§±Ë¥•:`, error);
        }
    }
    
    /**
     * Âº∫Âà∂Ëß¶ÂèëÂäüËÉΩ
     * @param {string} type - Á±ªÂûã ('break' | 'lunch')
     */
    forceTrigger(type) {
        try {
            console.log(`üîß Force trigger called for type: ${type}`);
            console.log('üîß Available objects:', {
                testEasterEgg: !!window.testEasterEgg,
                afternoonTeaEasterEgg: !!window.afternoonTeaEasterEgg,
                lunchReminder: !!window.lunchReminder,
                afternoonTeaReminder: !!window.afternoonTeaReminder
            });
            
            if (type === 'break') {
                // For afternoon tea, we want to trigger both the notification AND the easter egg
                console.log('üîß Triggering afternoon tea easter egg...');
                
                // Method 1: Direct easter egg popup trigger (PRIORITY - this is what user wants to see)
                if (window.afternoonTeaEasterEgg) {
                    try {
                        // Reset states to ensure popup shows
                        console.log('üîß Resetting easter egg states for testing...');
                        localStorage.removeItem('afternoonTeaFirstEasterEggShown');
                        localStorage.removeItem('afternoonTeaLastTrigger');
                        
                        // Force create UI if not exists
                        if (!window.afternoonTeaEasterEgg.ui) {
                            window.afternoonTeaEasterEgg.createUI();
                            console.log('üîß UI controller created');
                        }
                        
                        // Method A: Direct UI trigger (shows the actual popup)
                        if (window.afternoonTeaEasterEgg.ui && window.afternoonTeaEasterEgg.ui.showFirstEasterEgg) {
                            window.afternoonTeaEasterEgg.ui.showFirstEasterEgg();
                            console.log('üîß ‚úÖ Easter egg popup triggered via UI controller');
                            return;
                        }
                        
                        // Method B: Manual trigger method
                        if (window.afternoonTeaEasterEgg.manualTriggerFirst) {
                            window.afternoonTeaEasterEgg.manualTriggerFirst();
                            console.log('üîß ‚úÖ Easter egg popup triggered via manualTriggerFirst');
                            return;
                        }
                        
                        // Method C: Check first time trigger
                        window.afternoonTeaEasterEgg.checkFirstTimeTrigger();
                        console.log('üîß ‚úÖ Easter egg triggered via checkFirstTimeTrigger');
                        
                    } catch (error) {
                        console.warn('üîß Direct easter egg trigger failed:', error);
                    }
                }
                
                // Method 2: Fallback to testEasterEgg approach
                if (window.testEasterEgg && window.testEasterEgg.triggerAfternoonTea) {
                    window.testEasterEgg.triggerAfternoonTea();
                    console.log('üîß Triggered via testEasterEgg.triggerAfternoonTea');
                }
                
                // Method 3: Also trigger the notification for completeness
                if (window.afternoonTeaReminder) {
                    window.afternoonTeaReminder.triggerReminder();
                    console.log('üîß Also triggered notification via afternoonTeaReminder');
                }
                
                console.warn('üîß If popup didn\'t show, try: testEasterEgg.forceEasterEgg() in console');
                
            } else if (type === 'lunch') {
                console.log('üîß Triggering lunch reminder...');
                
                // For lunch, try multiple approaches
                if (window.testEasterEgg && window.testEasterEgg.triggerLunch) {
                    window.testEasterEgg.triggerLunch();
                    console.log('üîß Triggered lunch via testEasterEgg.triggerLunch');
                } else if (window.lunchReminder && window.lunchReminder.triggerReminder) {
                    // Reset state first
                    localStorage.removeItem('lunchReminderLastTrigger');
                    window.lunchReminder.triggerReminder();
                    console.log('üîß Triggered lunch via lunchReminder.triggerReminder');
                } else if (window.afternoonTeaEasterEgg && window.afternoonTeaEasterEgg.forceLunchReminderTrigger) {
                    window.afternoonTeaEasterEgg.forceLunchReminderTrigger();
                    console.log('üîß Triggered lunch via afternoonTeaEasterEgg.forceLunchReminderTrigger');
                } else {
                    console.warn('üîß No lunch trigger method available');
                    console.log('üîß Available lunchReminder methods:', window.lunchReminder ? Object.keys(window.lunchReminder) : 'lunchReminder not found');
                }
            }
        } catch (error) {
            console.error(`üîß Force trigger ${type} failed:`, error);
        }
    }
    
    /**
     * ÈáçÁΩÆÁâπÂÆöÁä∂ÊÄÅ
     * @param {string} type - Á±ªÂûã ('break' | 'lunch')
     */
    resetSpecificState(type) {
        try {
            if (type === 'break') {
                localStorage.removeItem('afternoonTeaLastTrigger');
                localStorage.removeItem('afternoonTeaFirstEasterEggShown');
                console.log('üîß ‰∏ãÂçàËå∂Áä∂ÊÄÅÂ∑≤ÈáçÁΩÆ');
            } else if (type === 'lunch') {
                localStorage.removeItem('lunchReminderLastTrigger');
                localStorage.removeItem('lunchReminderUnlocked');
                console.log('üîß ÂçàÈ§êÁä∂ÊÄÅÂ∑≤ÈáçÁΩÆ');
            }
        } catch (error) {
            console.error(`üîß ÈáçÁΩÆ${type}Áä∂ÊÄÅÂ§±Ë¥•:`, error);
        }
    }
    
    /**
     * Ëé∑ÂèñË∞ÉËØï‰ø°ÊÅØ
     * @returns {Object}
     */
    getDebugInfo() {
        const info = {
            debugMode: this.isDebugMode,
            urlConfig: this.debugConfig,
            currentTime: new Date().toLocaleTimeString(),
            instances: {
                afternoonTeaEasterEgg: !!window.afternoonTeaEasterEgg,
                lunchReminder: !!window.lunchReminder,
                afternoonTeaReminder: !!window.afternoonTeaReminder
            },
            storage: {
                afternoonTeaLastTrigger: localStorage.getItem('afternoonTeaLastTrigger'),
                lunchReminderLastTrigger: localStorage.getItem('lunchReminderLastTrigger'),
                firstEasterEggShown: localStorage.getItem('afternoonTeaFirstEasterEggShown'),
                lunchReminderUnlocked: localStorage.getItem('lunchReminderUnlocked')
            },
            constants: {
                afternoonTeaTime: window.AFTERNOON_TEA_CONSTANTS ? 
                    `${window.AFTERNOON_TEA_CONSTANTS.REMINDER_TIME.HOUR}:${String(window.AFTERNOON_TEA_CONSTANTS.REMINDER_TIME.MINUTE).padStart(2, '0')}` : 'Êú™Áü•',
                lunchTime: window.LUNCH_REMINDER_CONSTANTS ? 
                    `${window.LUNCH_REMINDER_CONSTANTS.REMINDER_TIME.HOUR}:${String(window.LUNCH_REMINDER_CONSTANTS.REMINDER_TIME.MINUTE).padStart(2, '0')}` : 'Êú™Áü•'
            }
        };
        
        console.log('üîß Ë∞ÉËØï‰ø°ÊÅØ:', info);
        return info;
    }
    
    /**
     * ÊòæÁ§∫Ë∞ÉËØïÂ∏ÆÂä©
     */
    showDebugHelp() {
        console.log('üîß Ë∞ÉËØïÊ®°ÂºèÂ∏ÆÂä©ÊñáÊ°£');
        console.log('');
        console.log('üìñ URLÂèÇÊï∞‰ΩøÁî®ÊñπÊ≥ï:');
        console.log('  https://hydrate-move.lightyearai.info/zh?debug=1');
        console.log('  https://hydrate-move.lightyearai.info/zh?debug=1&reset=true');
        console.log('  https://hydrate-move.lightyearai.info/zh?debug=1&trigger=break');
        console.log('  https://hydrate-move.lightyearai.info/zh?debug=1&trigger=lunch');
        console.log('  https://hydrate-move.lightyearai.info/zh?debug=1&break_time=16:05');
        console.log('  https://hydrate-move.lightyearai.info/zh?debug=1&lunch_time=12:30');
        console.log('');
        console.log('üõ†Ô∏è ÊéßÂà∂Âè∞ÂëΩ‰ª§:');
        console.log('  testEasterEgg.setBreakTime("16:05") // ËÆæÁΩÆ‰∏ãÂçàËå∂Êó∂Èó¥');
        console.log('  testEasterEgg.setLunchTime("12:30") // ËÆæÁΩÆÂçàÈ§êÊó∂Èó¥');
        console.log('  testEasterEgg.triggerBreak() // Âº∫Âà∂Ëß¶Âèë‰∏ãÂçàËå∂');
        console.log('  testEasterEgg.triggerLunch() // Âº∫Âà∂Ëß¶ÂèëÂçàÈ§ê');
        console.log('  testEasterEgg.forceEasterEgg() // Áõ¥Êé•Ëß¶ÂèëÂΩ©ËõãÔºàÁªïËøáÊó∂Èó¥Ê£ÄÊü•Ôºâ');
        console.log('  testEasterEgg.showEasterEgg() // ÊâãÂä®ÊòæÁ§∫Á¨¨‰∏ÄÂ±ÇÂΩ©Ëõã');
        console.log('  testEasterEgg.testNotification() // ÊµãËØïÈÄöÁü•ÊùÉÈôê');
        console.log('  testEasterEgg.resetBreak() // ÈáçÁΩÆ‰∏ãÂçàËå∂Áä∂ÊÄÅ');
        console.log('  testEasterEgg.resetLunch() // ÈáçÁΩÆÂçàÈ§êÁä∂ÊÄÅ');
        console.log('  testEasterEgg.getDebugInfo() // Ëé∑ÂèñË∞ÉËØï‰ø°ÊÅØ');
        console.log('  testEasterEgg.reset() // ÈáçÁΩÆÊâÄÊúâÁä∂ÊÄÅ');
        console.log('  testEasterEgg.showStatus() // ÊòæÁ§∫Áä∂ÊÄÅ');
    }
    
    /**
     * Execute URL commands
     * @private
     */
    executeUrlCommands() {
        if (!this.isDebugMode) {
            return;
        }
        
        console.log('üîß Executing URL debug commands...');
        
        // Wait for testEasterEgg to be available before executing commands
        const executeWithRetry = (attempt = 1, maxAttempts = 30) => {
            console.log(`üîß Execute attempt ${attempt}/${maxAttempts}`);
            
            // Check if essential objects are available
            const essentialObjectsReady = window.testEasterEgg && 
                                        (window.afternoonTeaEasterEgg || window.afternoonTeaReminder);
            
            if (!essentialObjectsReady) {
                if (attempt <= maxAttempts) {
                    console.log(`üîß Waiting for essential objects... attempt ${attempt}`);
                    console.log('üîß Object status:', {
                        testEasterEgg: !!window.testEasterEgg,
                        afternoonTeaEasterEgg: !!window.afternoonTeaEasterEgg,
                        afternoonTeaReminder: !!window.afternoonTeaReminder,
                        lunchReminder: !!window.lunchReminder
                    });
                    setTimeout(() => executeWithRetry(attempt + 1, maxAttempts), 500);
                    return;
                } else {
                    console.error('üîß Essential objects not available after 15 seconds');
                    console.error('üîß Final object status:', {
                        testEasterEgg: !!window.testEasterEgg,
                        afternoonTeaEasterEgg: !!window.afternoonTeaEasterEgg,
                        afternoonTeaReminder: !!window.afternoonTeaReminder,
                        lunchReminder: !!window.lunchReminder
                    });
                    return;
                }
            }
            
            console.log('üîß testEasterEgg found, executing URL commands...');
            
            // Auto-reset state
            if (this.debugConfig.autoReset) {
                if (window.testEasterEgg.reset) {
                    window.testEasterEgg.reset();
                    console.log('üîß Auto-reset all states completed');
                } else {
                    console.warn('üîß testEasterEgg.reset method not found');
                }
            }
            
            // Set times
            if (this.debugConfig.breakTime) {
                this.setTriggerTime('break', this.debugConfig.breakTime);
            }
            
            if (this.debugConfig.lunchTime) {
                this.setTriggerTime('lunch', this.debugConfig.lunchTime);
            }
            
            // Force trigger
            if (this.debugConfig.triggerType) {
                setTimeout(() => {
                    console.log(`üîß Attempting to force trigger: ${this.debugConfig.triggerType}`);
                    this.forceTrigger(this.debugConfig.triggerType);
                }, 500);
            }
            
            // Show debug info
            setTimeout(() => {
                this.getDebugInfo();
            }, 1000);
        };
        
        executeWithRetry();
    }
    
    /**
     * Validate time format
     * @param {string} time 
     * @returns {boolean}
     */
    validateTimeFormat(time) {
        if (typeof time !== 'string') return false;
        
        const timeRegex = /^([01]?\d|2[0-3]):([0-5]?\d)$/;
        return timeRegex.test(time);
    }
}

// Auto-initialize debug mode manager
if (typeof window !== 'undefined') {
    // Ensure DOM is ready before initialization
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            window.debugModeManager = new DebugModeManager();
        });
    } else {
        window.debugModeManager = new DebugModeManager();
    }
}

// Export for other modules
window.DebugModeManager = DebugModeManager;