class UIController{constructor(){this.elements={},this.isSettingsOpen=!1,this.currentNotification=null,this.eventListeners={},this.uiState={water:{isActive:!1,timeRemaining:0,status:"未启动",completedToday:0,targetToday:8},posture:{isActive:!1,timeRemaining:0,status:"未启动",completedToday:0,targetToday:8},settings:{isOpen:!1},help:{isOpen:!1}},this.bindEvents=this.bindEvents.bind(this),this.handleSettingsToggle=this.handleSettingsToggle.bind(this),this.handleHelpToggle=this.handleHelpToggle.bind(this),this.handleOutsideClick=this.handleOutsideClick.bind(this),this.handleNotificationKeydown=this.handleNotificationKeydown.bind(this)}initialize(){return console.log("初始化UI控制器..."),this.cacheElements(),this.bindEvents(),this.setupInitialState(),this}cacheElements(){this.elements={appContainer:document.getElementById("app"),appStatusIndicator:document.getElementById("app-status-indicator"),appStatusText:document.getElementById("app-status-text"),waterCard:document.getElementById("water-card"),waterStatus:document.getElementById("water-status"),waterStatusBadge:document.getElementById("water-status-badge"),waterTime:document.getElementById("water-time"),waterNextTime:document.getElementById("water-next-time"),waterToggle:document.getElementById("water-toggle"),waterReset:document.getElementById("water-reset"),waterDrink:document.getElementById("waterDrink"),waterStats:document.getElementById("water-stats"),waterProgress:document.getElementById("water-progress"),waterCount:document.getElementById("water-count"),postureCard:document.getElementById("posture-card"),postureStatus:document.getElementById("posture-status"),postureStatusBadge:document.getElementById("posture-status-badge"),postureTime:document.getElementById("posture-time"),postureNextTime:document.getElementById("posture-next-time"),postureToggle:document.getElementById("posture-toggle"),postureReset:document.getElementById("posture-reset"),postureActivity:document.getElementById("postureActivity"),postureStats:document.getElementById("posture-stats"),postureProgress:document.getElementById("posture-progress"),postureCount:document.getElementById("posture-count"),activityStatusValue:document.getElementById("activity-status-value"),startAllBtn:document.getElementById("start-all-btn"),pauseAllBtn:document.getElementById("pause-all-btn"),healthScore:document.getElementById("health-score"),settingsBtn:document.getElementById("settings-btn"),settingsPanel:document.getElementById("settings-panel"),settingsClose:document.getElementById("settings-close"),saveSettings:document.getElementById("save-settings"),resetSettings:document.getElementById("reset-settings"),waterEnabled:document.getElementById("water-enabled"),waterInterval:document.getElementById("water-interval"),waterIntervalSlider:document.getElementById("water-interval-slider"),waterTarget:document.getElementById("water-target"),postureEnabled:document.getElementById("posture-enabled"),postureInterval:document.getElementById("posture-interval"),postureIntervalSlider:document.getElementById("posture-interval-slider"),postureTarget:document.getElementById("posture-target"),activityDetection:document.getElementById("activity-detection"),browserNotifications:document.getElementById("browser-notifications"),soundEnabled:document.getElementById("sound-enabled"),notificationStyle:document.getElementById("notification-style"),themeSelector:document.getElementById("theme-selector"),notificationOverlay:document.getElementById("notification-overlay"),notificationIcon:document.getElementById("notification-icon"),notificationTitle:document.getElementById("notification-title"),notificationMessage:document.getElementById("notification-message"),notificationConfirm:document.getElementById("notification-confirm"),notificationSnooze:document.getElementById("notification-snooze"),helpBtn:document.getElementById("help-btn"),helpOverlay:document.getElementById("help-overlay"),helpClose:document.getElementById("help-close")};const e=["waterCard","postureCard","settingsPanel"].filter(e=>!this.elements[e]);e.length>0&&console.error("UI初始化错误: 缺少必要DOM元素",e)}bindEvents(){if(this.addEventHandler("settingsBtn","click",this.handleSettingsToggle),this.addEventHandler("settingsClose","click",this.handleSettingsToggle),this.addEventHandler("saveSettings","click",this.handleSaveSettings.bind(this)),this.addEventHandler("resetSettings","click",this.handleResetSettings.bind(this)),this.addEventHandler("helpBtn","click",this.handleHelpToggle),this.addEventHandler("helpClose","click",this.handleHelpToggle),this.addEventHandler("notificationConfirm","click",()=>{this.hideNotificationModal(),this.currentNotification&&this.currentNotification.onConfirm&&this.currentNotification.onConfirm()}),this.addEventHandler("notificationSnooze","click",()=>{this.hideNotificationModal(),this.currentNotification&&this.currentNotification.onSnooze&&this.currentNotification.onSnooze()}),this.addEventHandler("waterToggle","click",()=>{this.triggerEvent("waterToggle",{isActive:!this.uiState.water.isActive})}),this.addEventHandler("waterReset","click",()=>{this.triggerEvent("waterReset")}),this.addEventHandler("waterDrink","click",()=>{this.triggerEvent("waterDrink")}),this.addEventHandler("postureToggle","click",()=>{this.triggerEvent("postureToggle",{isActive:!this.uiState.posture.isActive})}),this.addEventHandler("postureReset","click",()=>{this.triggerEvent("postureReset")}),this.addEventHandler("postureActivity","click",()=>{this.triggerEvent("postureActivity")}),this.addEventHandler("startAllBtn","click",()=>{this.triggerEvent("startAll")}),this.addEventHandler("pauseAllBtn","click",()=>{this.triggerEvent("pauseAll")}),this.elements.waterIntervalSlider&&this.elements.waterInterval&&(this.elements.waterIntervalSlider.addEventListener("input",()=>{this.elements.waterInterval.value=this.elements.waterIntervalSlider.value}),this.elements.waterInterval.addEventListener("change",()=>{this.elements.waterIntervalSlider.value=this.elements.waterInterval.value})),this.elements.postureIntervalSlider&&this.elements.postureInterval&&(this.elements.postureIntervalSlider.addEventListener("input",()=>{this.elements.postureInterval.value=this.elements.postureIntervalSlider.value}),this.elements.postureInterval.addEventListener("change",()=>{this.elements.postureIntervalSlider.value=this.elements.postureInterval.value})),this.elements.themeSelector){const e=this.elements.themeSelector.querySelectorAll(".theme-option");e.forEach(t=>{t.addEventListener("click",()=>{e.forEach(e=>e.classList.remove("active")),t.classList.add("active");const s=t.getAttribute("data-theme");this.applyTheme(s)})})}}addEventHandler(e,t,s){const i=this.elements[e];i&&(this.eventListeners[e]||(this.eventListeners[e]={}),this.eventListeners[e][t]||(this.eventListeners[e][t]=[]),this.eventListeners[e][t].push(s),i.addEventListener(t,s))}removeEventHandlers(e,t){const s=this.elements[e];s&&this.eventListeners[e]&&this.eventListeners[e][t]&&(this.eventListeners[e][t].forEach(e=>{s.removeEventListener(t,e)}),this.eventListeners[e][t]=[])}on(e,t){this.eventListeners._custom||(this.eventListeners._custom={}),this.eventListeners._custom[e]||(this.eventListeners._custom[e]=[]),this.eventListeners._custom[e].push(t)}triggerEvent(e,t=null){this.eventListeners._custom&&this.eventListeners._custom[e]&&this.eventListeners._custom[e].forEach(s=>{try{s(t)}catch(t){console.error(`事件处理错误 (${e}):`,t)}})}setupInitialState(){console.log("设置UI初始状态..."),this.updateReminderStatus("water",{isActive:!1,timeRemaining:0,status:"未启动"}),this.updateReminderStatus("posture",{isActive:!1,timeRemaining:0,status:"未启动"}),this.updateDailyProgress("water",0,8),this.updateDailyProgress("posture",0,8),this.updateAppStatusSummary(!1),this.updateNextReminderTime("water",null),this.updateNextReminderTime("posture",null),this.updateActivityStatus(!0),this.updateHealthScore(0,0),this.hideSettings(),this.applyTheme("light"),this.checkMobileDevice()}checkMobileDevice(){window.innerWidth<768?document.body.classList.add("mobile-device"):document.body.classList.remove("mobile-device"),window.addEventListener("resize",()=>{window.innerWidth<768?document.body.classList.add("mobile-device"):document.body.classList.remove("mobile-device")})}applyTheme(e){"auto"===e?(window.matchMedia("(prefers-color-scheme: dark)").matches?document.body.classList.add("dark-theme"):document.body.classList.remove("dark-theme"),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",e=>{"auto"===this.getSettingsFromUI().appearance.theme&&(e.matches?document.body.classList.add("dark-theme"):document.body.classList.remove("dark-theme"))})):"dark"===e?document.body.classList.add("dark-theme"):document.body.classList.remove("dark-theme")}updateReminderStatus(e,t){const s=this.elements[`${e}Card`],i=this.elements[`${e}Status`],n=this.elements[`${e}StatusBadge`],a=this.elements[`${e}Time`],o=this.elements[`${e}Toggle`],l=this.elements[`${e}Reset`],r=this.elements["water"===e?"waterDrink":"postureActivity"];s&&i&&a&&o&&(t.isActive?s.classList.add("active"):s.classList.remove("active"),i.textContent=t.status||(t.isActive?"运行中":"未启动"),n&&(n.textContent=t.isActive?"运行中":"未启动",t.isActive?n.classList.add("active"):n.classList.remove("active")),t.isActive&&t.timeRemaining>0?(a.textContent=this.formatTime(t.timeRemaining),a.style.display="block"):(a.textContent="",a.style.display="none"),t.isActive?(o.textContent="暂停",o.className="btn-secondary",l&&(l.style.display="inline-block"),r&&(r.style.display="inline-block")):(o.textContent="开始",o.className="btn-primary",l&&(l.style.display="none"),r&&(r.style.display="none")),this.updateAppStatusSummary(this.uiState.water.isActive||this.uiState.posture.isActive),"water"===e?(this.uiState.water.isActive=t.isActive,this.uiState.water.status=t.status||(t.isActive?"运行中":"未启动"),this.uiState.water.timeRemaining=t.timeRemaining||0):"posture"===e&&(this.uiState.posture.isActive=t.isActive,this.uiState.posture.status=t.status||(t.isActive?"运行中":"未启动"),this.uiState.posture.timeRemaining=t.timeRemaining||0))}showNotificationModal(e,t,s,i,n){this.currentNotification={type:e,title:t,message:s,onConfirm:i,onSnooze:n},this.elements.notificationIcon&&(this.elements.notificationIcon.textContent="water"===e?"💧":"🧘"),this.elements.notificationTitle&&(this.elements.notificationTitle.textContent=t),this.elements.notificationMessage&&(this.elements.notificationMessage.textContent=s),this.elements.notificationConfirm&&(this.elements.notificationConfirm.textContent="water"===e?"已喝水":"已起身活动"),this.elements.notificationOverlay&&(this.elements.notificationOverlay.classList.add("show"),document.addEventListener("keydown",this.handleNotificationKeydown))}hideNotificationModal(){this.elements.notificationOverlay&&(this.elements.notificationOverlay.classList.remove("show"),document.removeEventListener("keydown",this.handleNotificationKeydown)),this.currentNotification=null}handleNotificationKeydown=e=>{"Escape"===e.key&&this.hideNotificationModal(),"Enter"===e.key&&this.currentNotification&&this.currentNotification.onConfirm&&(this.hideNotificationModal(),this.currentNotification.onConfirm())};toggleSettings(){this.isSettingsOpen?this.hideSettings():this.showSettings()}showSettings(){this.elements.settingsPanel&&(this.elements.settingsPanel.classList.add("open"),this.isSettingsOpen=!0,document.addEventListener("keydown",e=>{"Escape"===e.key&&this.hideSettings()}),document.addEventListener("click",this.handleOutsideClick))}hideSettings(){this.elements.settingsPanel&&(this.elements.settingsPanel.classList.remove("open"),this.isSettingsOpen=!1,document.removeEventListener("click",this.handleOutsideClick))}toggleHelp(){this.elements.helpOverlay&&(this.elements.helpOverlay.classList.contains("show")?this.elements.helpOverlay.classList.remove("show"):this.elements.helpOverlay.classList.add("show"))}handleOutsideClick=e=>{this.isSettingsOpen&&this.elements.settingsPanel&&!this.elements.settingsPanel.contains(e.target)&&e.target!==this.elements.settingsBtn&&this.hideSettings()};getSettingsFromUI(){let e="light";if(this.elements.themeSelector){const t=this.elements.themeSelector.querySelector(".theme-option.active");t&&(e=t.getAttribute("data-theme"))}return{water:{enabled:!this.elements.waterEnabled||this.elements.waterEnabled.checked,interval:this.elements.waterInterval?parseInt(this.elements.waterInterval.value):30,target:this.elements.waterTarget?parseInt(this.elements.waterTarget.value):8},posture:{enabled:!this.elements.postureEnabled||this.elements.postureEnabled.checked,interval:this.elements.postureInterval?parseInt(this.elements.postureInterval.value):60,target:this.elements.postureTarget?parseInt(this.elements.postureTarget.value):8,activityDetection:!this.elements.activityDetection||this.elements.activityDetection.checked},notifications:{browserNotifications:!this.elements.browserNotifications||this.elements.browserNotifications.checked,soundEnabled:!this.elements.soundEnabled||this.elements.soundEnabled.checked,style:this.elements.notificationStyle?this.elements.notificationStyle.value:"standard"},appearance:{theme:e}}}applySettingsToUI(e){e&&(e.water&&(this.elements.waterEnabled&&(this.elements.waterEnabled.checked=!1!==e.water.enabled),this.elements.waterInterval&&(this.elements.waterInterval.value=e.water.interval||30),this.elements.waterIntervalSlider&&(this.elements.waterIntervalSlider.value=e.water.interval||30),this.elements.waterTarget&&(this.elements.waterTarget.value=e.water.target||8)),e.posture&&(this.elements.postureEnabled&&(this.elements.postureEnabled.checked=!1!==e.posture.enabled),this.elements.postureInterval&&(this.elements.postureInterval.value=e.posture.interval||60),this.elements.postureIntervalSlider&&(this.elements.postureIntervalSlider.value=e.posture.interval||60),this.elements.postureTarget&&(this.elements.postureTarget.value=e.posture.target||8),this.elements.activityDetection&&(this.elements.activityDetection.checked=!1!==e.posture.activityDetection)),e.notifications&&(this.elements.browserNotifications&&(this.elements.browserNotifications.checked=!1!==e.notifications.browserNotifications),this.elements.soundEnabled&&(this.elements.soundEnabled.checked=!1!==e.notifications.soundEnabled),this.elements.notificationStyle&&(this.elements.notificationStyle.value=e.notifications.style||"standard")),e.appearance&&e.appearance.theme&&(this.applyTheme(e.appearance.theme),this.elements.themeSelector))&&this.elements.themeSelector.querySelectorAll(".theme-option").forEach(t=>{t.classList.remove("active"),t.getAttribute("data-theme")===e.appearance.theme&&t.classList.add("active")})}handleSettingsToggle(){this.toggleSettings()}handleHelpToggle(){this.toggleHelp()}handleSaveSettings(){this.triggerEvent("saveSettings")}handleResetSettings(){this.triggerEvent("resetSettings")}formatTime(e){if(e<=0)return"";const t=Math.floor(e/3600),s=Math.floor(e%3600/60),i=e%60;return t>0?`${t}:${s.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}`:`${s}:${i.toString().padStart(2,"0")}`}updateDailyProgress(e,t,s){const i=this.elements[`${e}Stats`],n=this.elements[`${e}Progress`];if(i){const n=i.querySelector(".stats-text");if(n){const i="water"===e?"杯":"次活动";n.textContent=`今日: ${t}/${s} ${i}`}}if(n){const e=Math.min(t/s*100,100);n.style.width=`${e}%`}}showInPageNotification(e,t,s,i,n){const a=document.createElement("div");a.className=`notification-alert notification-${e}`,a.innerHTML=`\n            <div class="notification-content">\n                <div class="notification-icon">${"water"===e?"💧":"🧘"}</div>\n                <div class="notification-text">\n                    <div class="notification-title">${t}</div>\n                    <div class="notification-message">${s}</div>\n                </div>\n                <button class="btn-close">✕</button>\n            </div>\n            <div class="notification-actions">\n                <button class="btn btn-primary">${"water"===e?"已喝水":"已起身活动"}</button>\n                <button class="btn btn-secondary">稍后提醒</button>\n            </div>\n        `,document.body.appendChild(a),setTimeout(()=>{a.classList.add("show")},100);const o=a.querySelector(".btn-primary"),l=a.querySelector(".btn-secondary"),r=a.querySelector(".btn-close"),d=()=>{a.classList.remove("show"),setTimeout(()=>{a.parentNode&&a.parentNode.removeChild(a)},300)};o&&o.addEventListener("click",()=>{d(),i&&i()}),l&&l.addEventListener("click",()=>{d(),n&&n()}),r&&r.addEventListener("click",d),setTimeout(d,1e4)}showPermissionPrompt(e,t){const s=document.createElement("div");s.className="permission-prompt",s.innerHTML='\n            <div class="prompt-content">\n                <div class="prompt-icon">🔔</div>\n                <div class="prompt-text">\n                    <h3>启用通知权限</h3>\n                    <p>允许发送桌面通知，即使在其他标签页也能收到提醒</p>\n                </div>\n                <div class="prompt-actions">\n                    <button class="btn-primary">允许通知</button>\n                    <button class="btn-secondary">暂不开启</button>\n                </div>\n            </div>\n        ',document.body.appendChild(s),setTimeout(()=>{s.classList.add("show")},100);const i=s.querySelector(".btn-primary"),n=s.querySelector(".btn-secondary"),a=()=>{s.classList.remove("show"),setTimeout(()=>{s.parentNode&&s.parentNode.removeChild(s)},400)};i&&i.addEventListener("click",()=>{a(),e&&e()}),n&&n.addEventListener("click",()=>{a(),t&&t()})}getElement(e){return this.elements[e]||document.getElementById(e)}setElementVisibility(e,t){const s=this.getElement(e);s&&(s.style.display=t?"block":"none")}setElementText(e,t){const s=this.getElement(e);s&&(s.textContent=t)}addElementClass(e,t){const s=this.getElement(e);s&&s.classList.add(t)}removeElementClass(e,t){const s=this.getElement(e);s&&s.classList.remove(t)}updateAppStatusSummary(e){this.elements.appStatusIndicator&&this.elements.appStatusText&&(e?(this.elements.appStatusIndicator.classList.add("active"),this.elements.appStatusText.textContent="健康提醒已启动"):(this.elements.appStatusIndicator.classList.remove("active"),this.elements.appStatusText.textContent="健康提醒未启动"))}updateNextReminderTime(e,t){const s=this.elements[`${e}NextTime`];if(s)if(t&&t instanceof Date){const e=t.getHours().toString().padStart(2,"0"),i=t.getMinutes().toString().padStart(2,"0");s.textContent=`${e}:${i}`}else s.textContent="--:--"}updateActivityStatus(e){this.elements.activityStatusValue&&(e?(this.elements.activityStatusValue.textContent="活跃",this.elements.activityStatusValue.classList.remove("inactive")):(this.elements.activityStatusValue.textContent="离开",this.elements.activityStatusValue.classList.add("inactive")))}updateHealthScore(e,t){if(!this.elements.healthScore)return;const s=Math.round(100*(.5*e+.5*t));let i="";i=s>=80?"score-excellent":s>=60?"score-good":s>=40?"score-average":"score-poor",this.elements.healthScore.classList.remove("score-excellent","score-good","score-average","score-poor"),this.elements.healthScore.classList.add(i),this.elements.healthScore.textContent=s}}