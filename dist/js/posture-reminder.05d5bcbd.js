class PostureReminder extends ReminderManager{constructor(t,i,s){super("posture",t,i,s),this.dailyActivityCount=0,this.dailyGoal=8,this.lastActivityTime=null,this.activityHistory=[],this.totalSittingTime=0,this.currentSittingStart=null,this.isUserAway=!1,this.awayStartTime=null,this.lastUserActivity=Date.now(),this.activityThreshold=60*(t.activityThreshold||5)*1e3,this.loadDailyData(),this.setupEnhancedActivityDetection(),console.log("久坐提醒器已创建")}loadDailyData(){try{const t=(new Date).toDateString(),i=localStorage.getItem("postureReminder_dailyData");if(i){const s=JSON.parse(i);s.date===t?(this.dailyActivityCount=s.count||0,this.activityHistory=s.history||[],this.lastActivityTime=s.lastActivityTime||null,this.totalSittingTime=s.totalSittingTime||0):this.resetDailyData()}}catch(t){console.warn("加载今日久坐数据失败:",t),this.resetDailyData()}}saveDailyData(){try{const t={date:(new Date).toDateString(),count:this.dailyActivityCount,history:this.activityHistory,lastActivityTime:this.lastActivityTime,totalSittingTime:this.totalSittingTime};localStorage.setItem("postureReminder_dailyData",JSON.stringify(t))}catch(t){console.warn("保存今日久坐数据失败:",t)}}resetDailyData(){this.dailyActivityCount=0,this.activityHistory=[],this.lastActivityTime=null,this.totalSittingTime=0,this.currentSittingStart=Date.now(),this.saveDailyData()}setupEnhancedActivityDetection(){if(!this.activityDetector)return;const t=this.activityDetector.callback;this.activityDetector.callback=i=>{t&&t(i),this.handleEnhancedActivityEvent(i)},this.startContinuousMonitoring()}handleEnhancedActivityEvent(t){const i=Date.now();switch(this.lastUserActivity=i,t.type){case"user-activity":this.isUserAway&&this.handleUserReturn(),this.isActive&&!this.isPaused&&this.handleActivityDuringReminder();break;case"user-away":this.handleUserAway();break;case"user-return":this.handleUserReturn()}}handleUserAway(){this.isUserAway||(this.isUserAway=!0,this.awayStartTime=Date.now(),this.currentSittingStart&&(this.totalSittingTime+=this.awayStartTime-this.currentSittingStart,this.currentSittingStart=null),this.isActive&&!this.isPaused&&this.pause(!0),console.log("用户离开，久坐提醒已自动暂停"))}handleUserReturn(){if(!this.isUserAway)return;const t=Date.now(),i=t-this.awayStartTime;this.isUserAway=!1,this.currentSittingStart=t,i>this.activityThreshold&&this.recordActivity("away-break",i),this.isActive&&this.isPaused&&this.resume(!0),console.log(`用户返回，离开时长: ${Math.round(i/6e4)}分钟`)}handleActivityDuringReminder(){const t=Date.now();if(t-this.lastUserActivity<3e4){const i=3e5;this.timeRemaining=Math.min(this.timeRemaining+i,60*this.settings.interval*1e3),this.nextReminderTime=t+this.timeRemaining,this.clearTimer(),this.startTimer(),console.log("检测到用户活动，久坐提醒已延长5分钟")}}startContinuousMonitoring(){this.monitoringInterval=setInterval(()=>{this.checkUserStatus()},6e4)}checkUserStatus(){Date.now()-this.lastUserActivity>this.activityThreshold&&!this.isUserAway&&this.handleUserAway(),this.currentSittingStart&&!this.isUserAway&&(this.totalSittingTime+=6e4)}confirmActivity(t=5,i="manual"){const s=Date.now();this.recordActivity(i,60*t*1e3),this.settings.lastReminder=s,this.reset(),this.showActivityConfirmation(t,i),this.triggerStatusChange({status:"activity-confirmed",isActive:!0,isPaused:!1,timeRemaining:this.timeRemaining,dailyCount:this.dailyActivityCount,dailyGoal:this.dailyGoal,lastActivityTime:this.lastActivityTime}),console.log(`已确认起身活动，今日第${this.dailyActivityCount}次`)}recordActivity(t,i){const s=Date.now();this.dailyActivityCount++,this.lastActivityTime=s,this.activityHistory.push({time:s,type:t,duration:i}),this.currentSittingStart=s,this.saveDailyData()}showActivityConfirmation(t,i){const s=Math.min(this.dailyActivityCount/this.dailyGoal,1),e=Math.round(100*s);let a=`很好！今日已活动 ${this.dailyActivityCount} 次`;this.dailyActivityCount>=this.dailyGoal?a+="\n🎉 恭喜！您已完成今日活动目标！":a+=`\n还需 ${this.dailyGoal-this.dailyActivityCount} 次即可完成今日目标 (${e}%)`,"away-break"===i&&(a+=`\n检测到您离开了 ${Math.round(t/6e4)} 分钟，很好的休息！`),this.notificationService.showInPageAlert("success",{title:"🧘 活动确认",message:a,duration:3e3}),this.dailyActivityCount===this.dailyGoal&&setTimeout(()=>{this.notificationService.showInPageAlert("celebration",{title:"🎉 目标达成！",message:"恭喜您完成今日活动目标！继续保持健康的工作习惯！",duration:5e3})},1e3)}triggerReminder(){if(!this.isActive)return;let t="久坐对身体不好，起来活动一下吧！";const i=Math.round(this.totalSittingTime/36e5*10)/10;if(this.dailyActivityCount>0){const i=Math.max(0,this.dailyGoal-this.dailyActivityCount);i>0?t+=`\n今日已活动 ${this.dailyActivityCount} 次，还需 ${i} 次完成目标`:t="继续保持良好的活动习惯！"}i>0&&(t+=`\n今日已坐着 ${i} 小时`),this.notificationService.showNotification("posture","🧘 该起身活动了！",t,()=>this.confirmActivity(),()=>this.snooze(),{actions:[{action:"activity",title:"已起身活动",icon:"🧘"},{action:"snooze",title:"5分钟后提醒",icon:"⏰"}]}),this.triggerStatusChange({status:"triggered",isActive:!0,isPaused:!1,timeRemaining:0,dailyCount:this.dailyActivityCount,dailyGoal:this.dailyGoal}),setTimeout(()=>{this.isActive&&0===this.timeRemaining&&this.reset()},6e4),console.log("久坐提醒已触发")}getDailyStats(){const t=this.activityHistory.reduce((t,i)=>t+i.duration,0),i=Math.min(this.dailyActivityCount/this.dailyGoal,1),s=Math.round(this.totalSittingTime/36e5*10)/10;return{count:this.dailyActivityCount,goal:this.dailyGoal,progress:i,progressPercent:Math.round(100*i),totalActivityTime:t,totalSittingTime:this.totalSittingTime,sittingHours:s,lastActivityTime:this.lastActivityTime,history:[...this.activityHistory],isGoalReached:this.dailyActivityCount>=this.dailyGoal,averageActivityDuration:this.activityHistory.length>0?Math.round(t/this.activityHistory.length/6e4):0}}setDailyGoal(t){t>0&&t<=20?(this.dailyGoal=t,this.saveDailyData(),console.log(`每日活动目标已设置为 ${t} 次`)):console.warn("每日目标应在1-20次之间")}setActivityThreshold(t){t>0&&t<=30?(this.activityThreshold=60*t*1e3,this.settings.activityThreshold=t,console.log(`活动阈值已设置为 ${t} 分钟`)):console.warn("活动阈值应在1-30分钟之间")}getHealthSuggestion(){const t=this.getDailyStats(),i=(new Date).getHours();return t.sittingHours>6?"今日坐着时间较长，建议增加活动频率，每30分钟起身一次":t.count<.5*t.goal&&i>14?"下午了，活动次数还不够，记得多起身走动":t.count>=t.goal?"今日活动目标已达成！继续保持良好习惯":i<12?"上午工作时间，记得每小时起身活动一下":i<18?"下午容易疲劳，适当活动有助于提高工作效率":"工作日即将结束，做些轻松的伸展运动吧"}getCurrentStatus(){return{...super.getCurrentStatus(),dailyStats:this.getDailyStats(),suggestion:this.getHealthSuggestion(),isUserAway:this.isUserAway,lastUserActivity:this.lastUserActivity,activityThreshold:this.activityThreshold}}start(){this.currentSittingStart||(this.currentSittingStart=Date.now()),super.start()}stop(){this.currentSittingStart&&(this.totalSittingTime+=Date.now()-this.currentSittingStart,this.currentSittingStart=null,this.saveDailyData()),this.monitoringInterval&&(clearInterval(this.monitoringInterval),this.monitoringInterval=null),super.stop()}reset(){super.reset();const t=(new Date).toDateString(),i=localStorage.getItem("postureReminder_dailyData");if(i)try{JSON.parse(i).date!==t&&this.resetDailyData()}catch(t){console.warn("检查日期数据失败:",t)}}destroy(){this.currentSittingStart&&(this.totalSittingTime+=Date.now()-this.currentSittingStart),this.saveDailyData(),this.monitoringInterval&&(clearInterval(this.monitoringInterval),this.monitoringInterval=null),super.destroy(),console.log("久坐提醒器已销毁")}}"undefined"!=typeof module&&module.exports&&(module.exports=PostureReminder);