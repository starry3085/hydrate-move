class AppSettings{constructor(t){this.storageManager=t,this.settingsKey="appSettings",this.stateKey="appState",this.defaultSettings={water:{enabled:!0,interval:30,sound:!0,lastReminder:null,target:8},posture:{enabled:!0,interval:60,sound:!0,lastReminder:null,activityThreshold:5,target:8,activityDetection:!0},notifications:{browserNotifications:!0,soundEnabled:!0,style:"standard"},appearance:{theme:"light",language:"zh-CN"},firstUse:!0},this.defaultState={waterReminder:{isActive:!1,timeRemaining:0,nextReminderAt:null,lastAcknowledged:null},postureReminder:{isActive:!1,timeRemaining:0,nextReminderAt:null,lastAcknowledged:null},userActivity:{isActive:!0,lastActivityTime:Date.now(),awayStartTime:null},lastSaved:Date.now()},this.currentSettings={...this.defaultSettings},this.currentState={...this.defaultState}}loadSettings(){try{const t=this.storageManager.loadSettings(this.settingsKey);return t?(this.currentSettings=this.mergeSettings(this.defaultSettings,t),console.log("已加载用户设置:",this.currentSettings)):(console.log("使用默认设置"),this.currentSettings={...this.defaultSettings}),this.currentSettings}catch(t){return console.warn("加载设置失败，使用默认设置:",t),this.currentSettings={...this.defaultSettings},this.currentSettings}}saveSettings(t=null){try{const e=t||this.currentSettings,r=this.storageManager.saveSettings(this.settingsKey,e);return r&&(this.currentSettings=e,console.log("设置已保存")),r}catch(t){return console.error("保存设置失败:",t),!1}}loadState(){try{const t=this.storageManager.loadSettings(this.stateKey);return t?this.isStateValid(t)?(this.currentState=this.mergeSettings(this.defaultState,t),console.log("已加载应用状态:",this.currentState)):(console.warn("保存的状态已过期或无效，使用默认状态"),this.currentState={...this.defaultState}):(console.log("没有找到保存的状态，使用默认状态"),this.currentState={...this.defaultState}),this.currentState}catch(t){return console.warn("加载状态失败，使用默认状态:",t),this.currentState={...this.defaultState},this.currentState}}saveState(t=null){try{const e=t||this.currentState;e.lastSaved=Date.now();const r=this.storageManager.saveSettings(this.stateKey,e);return r&&(this.currentState=e,console.log("应用状态已保存")),r}catch(t){return console.error("保存应用状态失败:",t),!1}}updateSettings(t){return this.currentSettings=this.mergeSettings(this.currentSettings,t),this.saveSettings(),this.currentSettings}updateState(t){return this.currentState=this.mergeSettings(this.currentState,t),this.saveState(),this.currentState}resetSettings(){return this.currentSettings={...this.defaultSettings},this.saveSettings(),this.currentSettings}resetState(){return this.currentState={...this.defaultState},this.saveState(),this.currentState}isStateValid(t){if(!t.lastSaved)return!1;const e=Date.now(),r=864e5;return e-t.lastSaved>r?(console.warn("应用状态已过期"),!1):t.waterReminder&&t.waterReminder.nextReminderAt&&e-t.waterReminder.nextReminderAt>r?(console.warn("水提醒时间已过期"),!1):!(t.postureReminder&&t.postureReminder.nextReminderAt&&e-t.postureReminder.nextReminderAt>r&&(console.warn("久坐提醒时间已过期"),1))}mergeSettings(t,e){const r={...t};for(const t in e)e.hasOwnProperty(t)&&(e[t]instanceof Object&&!Array.isArray(e[t])&&t in r?r[t]=this.mergeSettings(r[t],e[t]):r[t]=e[t]);return r}validateSettings(t){try{if(t.water){if("number"!=typeof t.water.interval||t.water.interval<5||t.water.interval>120)return console.warn("无效的水提醒间隔设置"),!1;if("number"!=typeof t.water.target||t.water.target<1||t.water.target>20)return console.warn("无效的水提醒目标设置"),!1}if(t.posture){if("number"!=typeof t.posture.interval||t.posture.interval<15||t.posture.interval>120)return console.warn("无效的久坐提醒间隔设置"),!1;if("number"!=typeof t.posture.target||t.posture.target<1||t.posture.target>20)return console.warn("无效的久坐提醒目标设置"),!1}return!0}catch(t){return console.error("设置验证失败:",t),!1}}getSettings(){return this.currentSettings}getState(){return this.currentState}markFirstUseComplete(){this.currentSettings.firstUse=!1,this.saveSettings()}isFirstUse(){return!0===this.currentSettings.firstUse}}"undefined"!=typeof module&&module.exports&&(module.exports=AppSettings);