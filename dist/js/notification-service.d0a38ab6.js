class NotificationService{constructor(){this.hasPermission=!1,this.isSupported="Notification"in window,this.soundEnabled=!0,this.audioContext=null,this.audioFiles={water:null,posture:null,default:null},this.isSupported&&"granted"===Notification.permission&&(this.hasPermission=!0),this.initAudioContext()}initAudioContext(){try{if(window.AudioContext||window.webkitAudioContext){const t=window.AudioContext||window.webkitAudioContext;this.audioContext=new t,console.log("音频上下文初始化成功")}else console.warn("浏览器不支持Web Audio API，将使用HTML5 Audio")}catch(t){console.warn("初始化音频上下文失败:",t),this.audioContext=null}}async requestPermission(){if(!this.isSupported)return console.warn("浏览器不支持通知功能"),!1;try{const t=await Notification.requestPermission();return this.hasPermission="granted"===t,this.hasPermission?console.log("通知权限已获得"):console.warn("用户拒绝了通知权限"),this.hasPermission}catch(t){return console.error("请求通知权限时出错:",t),!1}}showNotification(t,i,e,n,o){return this.showBrowserNotification(t,i,e)||this.showInPageAlert(t,i,e,n,o),this.soundEnabled&&this.playSound(t),!0}showBrowserNotification(t,i,e){if(!this.isSupported)return console.warn("浏览器不支持通知功能，使用页面内通知"),!1;if(!this.hasPermission)return console.warn("没有通知权限，使用页面内通知"),!1;try{const n={body:e,icon:this.getNotificationIcon(t),badge:this.getNotificationIcon(t),tag:`wellness-reminder-${t}`,requireInteraction:!0,silent:!this.soundEnabled,vibrate:[200,100,200]},o=new Notification(i,n);return o.onclick=()=>{window.focus(),o.close(),window.app&&window.app[`${t}Reminder`]&&window.app[`${t}Reminder`].acknowledge()},setTimeout(()=>{o.close()},3e4),!0}catch(t){return console.error("显示浏览器通知时出错:",t),!1}}showInPageAlert(t,i,e,n,o){this.hideInPageAlert();const s=window.mobileAdapter&&window.mobileAdapter.isMobile,a=document.createElement("div");a.className=`notification-alert notification-${t}${s?" mobile":""}`,a.id="wellness-notification",a.innerHTML=s?`\n                <div class="notification-content">\n                    <div class="notification-icon">\n                        ${this.getNotificationEmoji(t)}\n                    </div>\n                    <div class="notification-text">\n                        <h3 class="notification-title">${i}</h3>\n                        <p class="notification-message">${e}</p>\n                    </div>\n                </div>\n                <div class="notification-actions">\n                    <button class="btn btn-primary mobile-touch-feedback" id="confirm-btn">\n                        ${"water"===t?"已喝水":"已起身活动"}\n                    </button>\n                    <button class="btn btn-secondary mobile-touch-feedback" id="snooze-btn">\n                        稍后提醒\n                    </button>\n                </div>\n            `:`\n                <div class="notification-content">\n                    <div class="notification-icon">\n                        ${this.getNotificationEmoji(t)}\n                    </div>\n                    <div class="notification-text">\n                        <h3 class="notification-title">${i}</h3>\n                        <p class="notification-message">${e}</p>\n                    </div>\n                    <button class="btn btn-close" id="close-btn">×</button>\n                </div>\n                <div class="notification-actions">\n                    <button class="btn btn-primary" id="confirm-btn">\n                        ${"water"===t?"已喝水":"已起身活动"}\n                    </button>\n                    <button class="btn btn-secondary" id="snooze-btn">\n                        稍后提醒\n                    </button>\n                </div>\n            `,document.body.appendChild(a);const r=a.querySelector("#confirm-btn"),c=a.querySelector("#snooze-btn"),d=a.querySelector("#close-btn");if(r.addEventListener("click",()=>{this.hideInPageAlert(),n&&n()}),c.addEventListener("click",()=>{this.hideInPageAlert(),o&&o()}),d&&d.addEventListener("click",()=>{this.hideInPageAlert()}),s&&a.addEventListener("click",t=>{t.target===a&&this.hideInPageAlert()}),setTimeout(()=>{a.classList.add("show")},100),setTimeout(()=>{document.getElementById("wellness-notification")&&this.hideInPageAlert()},s?3e4:6e4),s&&navigator.vibrate)try{navigator.vibrate([200,100,200])}catch(t){console.warn("振动API不可用:",t)}}playSound(t){if(this.soundEnabled)try{this.audioContext?this.playBeepSound(t):this.playAudioFile(t)}catch(t){console.warn("播放音效失败:",t)}}isNotificationSupported(){return this.isSupported}setSoundEnabled(t){this.soundEnabled=t}getNotificationIcon(t){return"water"===t?"assets/water-icon.png":"posture"===t?"assets/posture-icon.png":"assets/default-icon.png"}getNotificationEmoji(t){return"water"===t?"💧":"posture"===t?"🧘":"⏰"}hideInPageAlert(){const t=document.getElementById("wellness-notification");t&&(t.classList.remove("show"),setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t)},300))}playBeepSound(t){try{if(!this.audioContext&&(this.initAudioContext(),!this.audioContext))throw new Error("音频上下文不可用");"suspended"===this.audioContext.state&&this.audioContext.resume();const i=this.audioContext.createOscillator(),e=this.audioContext.createGain();i.connect(e),e.connect(this.audioContext.destination),"water"===t?(i.type="sine",i.frequency.value=800,e.gain.value=.1,i.start(),e.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+.3),setTimeout(()=>{i.stop()},300)):"posture"===t?(i.type="triangle",i.frequency.value=600,e.gain.value=.1,i.start(),setTimeout(()=>{i.frequency.value=700},200),setTimeout(()=>{i.stop()},400)):(i.type="sine",i.frequency.value=700,e.gain.value=.1,i.start(),setTimeout(()=>{i.stop()},200))}catch(i){console.warn("Web Audio API不可用:",i),this.playAudioFile(t)}}playAudioFile(t){try{if(!this.audioFiles[t]){const i=new Audio;i.volume=.5,i.src="water"===t?"assets/water-reminder.mp3":"posture"===t?"assets/posture-reminder.mp3":"assets/notification.mp3",this.audioFiles[t]=i}const i=this.audioFiles[t];i.currentTime=0,i.play().catch(i=>{if(console.warn("播放音频失败:",i),"NotAllowedError"===i.name){const i=new Audio;i.volume=.5,i.src="water"===t?"assets/water-reminder.mp3":"posture"===t?"assets/posture-reminder.mp3":"assets/notification.mp3",i.play().catch(t=>{console.warn("二次尝试播放音频失败:",t)})}})}catch(t){console.warn("HTML5 Audio不可用:",t)}}checkPermissionStatus(){return this.isSupported?Notification.permission:"unsupported"}showPermissionPrompt(t){const i=document.createElement("div");i.className="permission-prompt",i.id="notification-permission-prompt",i.innerHTML='\n            <div class="prompt-content">\n                <div class="prompt-icon">🔔</div>\n                <div class="prompt-text">\n                    <h3>启用通知</h3>\n                    <p>为了更好地提醒您喝水和起身活动，请允许浏览器通知权限。</p>\n                </div>\n                <div class="prompt-actions">\n                    <button class="btn btn-primary" id="request-permission-btn">允许通知</button>\n                    <button class="btn btn-secondary" id="dismiss-prompt-btn">稍后再说</button>\n                </div>\n            </div>\n        ',document.body.appendChild(i);const e=i.querySelector("#request-permission-btn"),n=i.querySelector("#dismiss-prompt-btn");e.addEventListener("click",()=>{this.hidePermissionPrompt(),t&&t()}),n.addEventListener("click",()=>{this.hidePermissionPrompt()}),setTimeout(()=>{i.classList.add("show")},100)}hidePermissionPrompt(){const t=document.getElementById("notification-permission-prompt");t&&(t.classList.remove("show"),setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t)},300))}}